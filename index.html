<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>AR Video | TOP</title>

    <!-- CSS -->
    <link rel="stylesheet" href="./css/style.css" />

    <!-- äº‹å‰ãƒ­ãƒ¼ãƒ‰ -->
    <link rel="preload" as="video" href="./assets/video-01.mp4" type="video/mp4">
    <link rel="preload" as="video" href="./assets/video-02.mp4" type="video/mp4">
    <link rel="preload" as="video" href="./assets/video-03.mp4" type="video/mp4">
    <link rel="preload" as="fetch" href="./assets/marker-ptn01.patt" crossorigin="anonymous">
    <link rel="preload" as="fetch" href="./assets/marker-ptn02.patt" crossorigin="anonymous">
    <link rel="preload" as="fetch" href="./assets/marker-ptn03.patt" crossorigin="anonymous">

    <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <!-- JavaScript -->
    <script src="./js/videoPlayer.js" defer></script>
    <script src="./js/videoPlane.js" defer></script>
    <script src="./js/arMarker.js" defer></script>
    <script src="./js/loadingManager.js" defer></script>
    <script src="./js/statusDisplay.js" defer></script>
    <script src="./js/arSceneManager.js" defer></script>

    <!-- ãƒ•ã‚¡ãƒ“ã‚³ãƒ³ -->
    <link rel="icon" href="./favicon.ico" type="image/x-icon" />
</head>
<body>
    <header class="fixed-header">
        <div class="header-content">
            <div class="header-logo">
                <a href="./index.html">LOGO</a>
            </div>
            <nav class="header-nav">
                <ul>
                    <li><a href="./guide.html">ä½¿ã„æ–¹</a></li>
                    <li><a href="./benefit.html">ç‰¹å…¸</a></li>
                    <li><a href="./infomation.html">å‹•ä½œç’°å¢ƒ</a></li>
                </ul>
            </nav>
        </div>
        <div class="header-debug">
            <p id="status-text">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: å¾…æ©Ÿä¸­</p>
        </div>
    </header>

    <main>
        <div id="interaction-overlay">
            <div class="interaction-prompt">
                <p>ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¨ARä½“é¨“ã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã€<br/>
                    "ARä½“é¨“ã‚’é–‹å§‹" ã‚’ã‚¿ãƒƒãƒ—ï¼<br>
                    <br>ã€åˆ©ç”¨æ–¹æ³•ã€‘<br>
                    1. ãƒãƒ¼ã‚«ãƒ¼ã‹ã‚‰15-30cm é›¢ã—ã¦ã‚«ãƒ¡ãƒ©ã‚’å‘ã‘ã‚‹<br>
                    2. ãƒãƒ¼ã‚«ãƒ¼ãŒèªè­˜ã•ã‚Œã‚‹ã¨å‹•ç”»ãŒå†ç”Ÿã•ã‚Œã¾ã™<br>
                    3. å†ç”Ÿã§ããªã„æ™‚ã¯ã€ã€Œç‰¹å…¸ã€ãƒšãƒ¼ã‚¸ã‚’è¦‹ã¦ã­
                </p>
                <button id="start-ar-btn">ARä½“é¨“ã‚’é–‹å§‹</button>
            </div>
        </div>

        <div id="loading">
            <div class="spinner"></div>
            <div id="loading-percentage">Loading: 0%</div>
        </div>
    </main>

    <a-scene
        id="ar-scene"
        embedded
        arjs="
        sourceType: webcam;
        debugUIEnabled: false;
        multiMarker: false;
        independentMarkers: true;
        maxDetectionRate: 30;
        detectionMode: mono_and_matrix;
        matrixCodeType: 3x3;
        trackingMethod: best;
        displayWidth: 640;
        displayHeight: 480;"
        style="width: 100vw; height: 100vh; overflow: hidden; display: none; position: fixed; top: 0; left: 0;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
    >
        <a-assets>
            <video id="video-01" 
                src="./assets/video-01.mp4" 
                loop 
                muted 
                playsinline 
                preload="metadata"
                crossorigin="anonymous"
                webkit-playsinline="true"></video>
            <video id="video-02" 
                src="./assets/video-02.mp4" 
                loop 
                muted 
                playsinline 
                preload="metadata"
                crossorigin="anonymous"
                webkit-playsinline="true"></video>
            <video id="video-03" 
                src="./assets/video-03.mp4" 
                loop 
                muted 
                playsinline 
                preload="metadata"
                crossorigin="anonymous"
                webkit-playsinline="true"></video>
        </a-assets>

        <a-marker type="pattern" url="./assets/marker-ptn01.patt" id="marker-01" 
                patternRatio="0.5" markerhandler>
            <a-plane id="plane-01" 
                        position="0 0 0" 
                        rotation="-90 0 0" 
                        width="2" 
                        height="1.125"
                        material="src: #video-01; shader: flat; transparent: true; opacity: 0"
                        visible="true"></a-plane>
        </a-marker>

        <a-marker type="pattern" url="./assets/marker-ptn02.patt" id="marker-02" 
                patternRatio="0.5" markerhandler>
            <a-plane id="plane-02" 
                        position="0 0 0" 
                        rotation="-90 0 0" 
                        width="2" 
                        height="1.125"
                        material="src: #video-02; shader: flat; transparent: true; opacity: 0"
                        visible="false"></a-plane>
        </a-marker>

        <a-marker type="pattern" url="./assets/marker-ptn03.patt" id="marker-03" 
                patternRatio="0.5" markerhandler>
            <a-plane id="plane-03" 
                        position="0 0 0" 
                        rotation="-90 0 0" 
                        width="2" 
                        height="1.125"
                        material="src: #video-03; shader: flat; transparent: true; opacity: 0"
                        visible="false"></a-plane>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
    document.addEventListener("DOMContentLoaded", () => {
        console.log("DOM loaded, initializing AR scene...");
        
        const sceneManager = new ARSceneManager({
            loadingSelector: "#loading",
            statusSelector: "#status-text",
            interactionOverlaySelector: "#interaction-overlay"
        });

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ç”¨ï¼ˆãƒ‡ãƒãƒƒã‚°ç›®çš„ï¼‰
        window.arSceneManager = sceneManager;

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã§ARé–‹å§‹
        const startBtn = document.getElementById("start-ar-btn");
        startBtn.addEventListener("click", async () => {
            console.log("Start AR button clicked");
            try {
                await sceneManager.startAR();
            } catch (error) {
                console.error("Failed to start AR:", error);
            }
        });

        // A-Frameã‚·ãƒ¼ãƒ³ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        const arScene = document.getElementById("ar-scene");
        arScene.addEventListener("enter-vr", () => {
            console.log("AR scene entered");
        });

        arScene.addEventListener("exit-vr", () => {
            console.log("AR scene exited");
        });

        // ãƒ‡ãƒãƒƒã‚°ç”¨ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã®ã¿ï¼‰
        document.addEventListener("keydown", (event) => {
            if (!sceneManager.isARReady) return;
            
            switch(event.key) {
                case 'd': // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
                    sceneManager.debugMarkerPositions();
                    break;
                case 'r': // ä½ç½®ãƒªã‚»ãƒƒãƒˆ
                    // sceneManager.resetAllPositions();
                    console.log("Position reset disabled in single marker mode");
                    break;
                case 'c': // ğŸ†• ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º
                    console.log("Current active marker:", sceneManager.currentActiveMarker);
                    break;
                case 's': // ğŸ†• å˜ä¸€è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ç¢ºèª
                    console.log("Single marker mode status:", {
                        maxSimultaneous: sceneManager.maxSimultaneousMarkers,
                        currentActive: sceneManager.currentActiveMarker,
                        conflictDetection: sceneManager.conflictDetectionEnabled
                    });
                    break;
                // case '1': // ãƒãƒ¼ã‚«ãƒ¼01ã®ä½ç½®èª¿æ•´ï¼ˆç„¡åŠ¹åŒ–ï¼‰
                // case '2': // ãƒãƒ¼ã‚«ãƒ¼02ã®ä½ç½®èª¿æ•´ï¼ˆç„¡åŠ¹åŒ–ï¼‰
                // case '3': // ãƒãƒ¼ã‚«ãƒ¼03ã®ä½ç½®èª¿æ•´ï¼ˆç„¡åŠ¹åŒ–ï¼‰
            }
        });

        console.log("Event listeners attached with single marker debug controls");
        console.log("Debug keys: d=debug info, c=current marker, s=single mode status");
    });
    </script>
</body>
</html>